---
layout: single
title: "북스터디 - 대규모 시스템 설계 기초_6장"
categories: 북스터디
tag: [키-값]
toc: true
toc_sticky: true 
---

# "6장 키-값 저장소 설계"

### 키-값 저장소
```
- 키-값 데이터베이스로 불리는 비 관계형 데이터베이스이다.
- 값은 문자열,리스트,객체 등일 수 있다.
- 아마존 다이나모,레디스,memcached 등이 있다.

- put(key, value) : 키-값 쌍을 저장소에 저장
- get(key) : 인자로 주어진 키에 해당하는 값을 꺼냄
```

### 문제 이헤 및 설계 범위 확정
```
- 완벽한 설계란 없다.
- 읽기,쓰기,메모리 사용량 간의 균형
- 데이터의 일관성과 가용성 사이에서 타협적 결정을 내린 설계를 만들어야 함.
```

### 키-값 저장소의 특성
```
- 키-값 쌍의 크기는 10KB이하
- 큰 데이터를 저장할 수 있어야 함
- 높은 가용성 : 시스템 장애가 있더라도 빠른 응답이 필요
- 높은 규모 확장성을 제공 : 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어 져야함
- 데이터 일관성 수준은 조정이 가능해야 한다.
- 응답 지연시간이 짧아야 한다.
```

### 단일 서버 키-값 저장소
```
- 단일 서버만 사용하는 키-값 저장소를 설계하는 것은 쉽다.
 => 키-값 쌍 전부를 메모리에 해시 테이블로 저장
 => 빠른 속도는 보장하지만 모든 데이터를 메모리 안에 두는 것은 불가능 할수 있다.

 개선책
 - 데이터 압축
 - 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크 저장
```

### 분산 키-값 저장소
```
- "분산 해시 테이블"이라고도 불린다
- 키-값 쌍을 여러 서버에 분산 시킨다.

CAP정리
 - 데이터 일관성, 가용성, 파티션 감내 라는 3가지 요구사항을 동시에 만족하는 분산시스템을 설계하는 것은 불가능하다는 정리
 - 3가지 요구사항중 두 가지를 충족하려면 나머지 하나는 반드시 희생되어야 함을 의미한다.

3가지 요구사항의 의미
 데이터 일관성 : 특정 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 봐야한다.
 가용성 : 일부 노드에 장애가 발생해도 항상 응답을 받아야 한다.
 파티션 감내 : 파티션은 두 노드 사이에 통신 장애가 발생했음을 의미하며, 파티션 감내는 네트워크에 파티션이 생겨도 시스템은 계속 동작해야 한다는 것을 뜻한다.

CP 시스템 : 일관성과 파티션 감내를 지원하는 키-값 저장소. 가용성을 의생
AP 시스템 : 가용성과 파티션 감내를 지원하는 키-값 저장소. 데이터 일관성을 희생
CA 시스템 : 일관성과 가용성을 지원하는 키-값 저장소. 파티션 감내를 희생.
         => 통상 네트워크 장애는 피할 수 없는 일이며, 분산 시스템은 반드시 파티션 문제를 감내할 수 있도록 설계해야 한다.
         => 실세계에서 CA시스템은 존재하지 않는다.

이상적 상태
 - 네트워크가 파티션되는 상황이 절대로 일어나지 않는 것이다.

실세계의 분산 시스템
 - 분산 시스템은 파티션 문제를 피할 수 없다.
 - 파티션 문제 발생 시 일관성과 가용성 사이에서 하나를 선택해야 한다.

은행권 시스템은 보통 데이터 일관성을 양보하지 않는다.
=> 온라인 뱅킹 시스템이 계좌 최신 정보를 출력하지 못하면 큰 문제이다.
=> 일관성이 깨질수 있는 상황 발생시 상황이 해결될 때 까지는 오류를 반환


일관성 대신 가용성을 선택한 시스템(AP 시스템)의 경우
 => 설사 낡은 데이터를 반환할 위험이 있어도 계속 읽기 연산을 허용해야 한다.

널리 사용되고 있는 세 가지 키-값 저장소
 - 다이나모
 - 카산드라
 - 빅테이블
```

### 시스템 컴포넌트
```
 키-값 저장소 구현에 사용될 핵심 컨포넌트 기술들
 - 데이터 파티션
 - 데이터 다중화
 - 일관성
 - 일관성 불일치 해소
 - 장애 처리
 - 시스템 아키텍처 다이어그램
 - 쓰기 경로
 - 읽기 경로

--------------------------------------------------------------------------------------------------------
데이터 파티션
 - 데이터를 작은 파티션들로 분할 후 여러 대 서버에 저장
 => 데이터를 파티션 단위로 나눌때 염두해야할 두가지
   - 데이터를 여러 서버에 고르게 분산 할 수 있는가
   - 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화 할수 있는가

안정해시를 사용하여 데이터를 파티션하면 좋은점
 - 규모 확장 자동화 : 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들수 있다.
 - 다양성 : 각 서버의 용량에 맞게 가상 노드의 수를 조정, 고성능 서버는 더 많은 가상 노드를 갖도록 설정
--------------------------------------------------------------------------------------------------------
데이터 다중화
- 높은 가용성과 안정성을 확보하기 위해 데이터를 N개 서버에 비동기적으로 다중화할 필요가 있다.
- N = 튜닝 가능한 값

- N개 서버를 선정하는 방법
  => 어떤 키를 해시 링 위에 배치 후, 그 지점 부터 시계 방향으로 링을 순회하며 만나는 N개 서버에 데이터 사본을 보관

- 가상 노드 사용시 실제 물리 서버의 개수가 N보다 잘아질 수 있다.
- 노드를 선택할 때 같은 물리 서버를 중복 선택하지 않도록 해야한다.
- 안정성을 담보하기 위해 데이터의 사본은 다른 센터의 서버세 보관하고 센터들 끼리는 고속 네트워크로 연결
--------------------------------------------------------------------------------------------------------
데이터 일관성
- 여러 노드에 다중화된 데이터는 적절히 동기화가 되어야 한다.
- 정족수 합의 프로토콜 사용 시 일기/쓰기 연산 모두에 일관성을 보장
- 
N = 사본개수
W = 쓰기
R = 읽기

W=1 은 데이터가 한 대의 서버에만 기록된다는 뜻이 아니다.
쓰기 연산이 성공했다고 판단하기 위해 중재자는 최소 한대 서버로부터 쓰기 성공 응답을 받아야 한다는 뜻이다.

중재자 : 클라이언트와 노드 사이에서 프록시 역할

```



