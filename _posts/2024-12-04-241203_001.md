---
layout: single
title: "북스터디 - 대규모 시스템 설계 기초_5장"
categories: 북스터디
tag: [북스터디, 확장성, 해시, 안정해시, 해시키]
toc: true
toc_sticky: true 
---
# "5장 안정 해시 설계"

## 안정 해시
```
 - 수평적 규모 확장성 달성(요청 및 데이터를 서버에 균등하게 처리)을 위해 보편적으로 사용하는 기술
```

## 해시 키 재배치(rehash) 문제
```
- 서버들에 부하를 균등하게 나누기 위해 보편적으로 아래와 같은 해시 함수를 사용 <br>
 > serverlndex = hash (key) % N (N 은 서버의 개수이다)
```

### 예) 총 4대의 서버 사용 시
|  키  |   해시   |해시 % 4 (서버인덱스) |
| ---- | -------- | - |
| key0 | 18358617 | 1 |
| key1 | 26143584 | 0 |
| key2 | 18131146 | 2 |
| key2 | 35863496 | 0 |

```
서버 풀의 크기가 고정되어 있을때, 데이터 분포가 균등할때는 잘 작동한다.
서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

4개의 서버중 1번 서버가 장애를 일으켜 동작을 중단하는 경우
서버풀의 크기는 3으로 변하며, 키에 대한 해시 값은 변하지않지만 나머지(%)연산을 적용하여 계산한 서버 인덱스 값은 서버수가 1만큼 줄어들면서 달라진다.
그 영향으로 장애가 발생한 1번 서버에 보관되어 있는 키 뿐만 아닌 대부분의 키가 재분배 되며,
1번 서버가 죽으면 대부분 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 된다.

대규모 캐시미스가 발생
안정해시는 이 문제를 효과적으로 해결하는 기술이다.
```

### 안정해시
```
해시테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술
k = 키의 개수
n = 슬롯
```

### 해시 공간과 해시 링
```
안정해시의 동작원리
SHS-1의 해시공간 범위 = 0 ~ (2의 160제곱 - 1)
x0 = 0, xn = (2의 160제곱 -1)

해시 링 : 해시공간의 양쪽을 동그랗게 배치
해시 키 : 해시링 위의 어느지점에 배치할수 있는 캐시할 키
서버조회 : 어떤 키가 저장되는 서버는, "해당 키의 위치에서 시계방향으로 링을 탐색"하며 만나는 첫번째 서버
서버 추가 : 서버를 추가하더라도 키 가운데 일부만 재배치하면 됨
           -> 서버조회를 통해 새로 추가된 서버의 시계반대방향의 해시 키가 해당 서버조회하게 됨

서버 제거 : 제거된 서버의 시계반대방향의 해시 키는 제거된 서버의 시계방향의 서버를 조회하게됨

```

### 기본 구현법의 기본 절차
```
- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 시계방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버
```

### 기본 구현법의 두가지 문제
```
- 서버가 추가되거나 삭제되는 상황을 감안하면 "파티션의 크기"를 균등하게 유지하는 게 불가능
- "키의 균등 분포"를 달성하기 어렵다
```

### 가상 노드
```
- 실제 노드 또는 서버를 가리키는 노드이며, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질수 있다.
- 키의 위치로부터 시계방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버이다.
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다.
- 표준 편차가 작아져서 데이터가 고르게 분포된다.
표준 편차: 데이터가 어떻게 퍼져 나갔는지를 보이는 척도
- 100~200개의 가상 노드를 사용하는 경우 표춘 편차값은 평균의 5%(가상노드 200개) ~ 10%(가상노드 100개) 사이
- 가상노드를 늘릴수록 표준 편차의 값은 떨어지지만 가상 노드 데이터를 저장할 공간은 더 많이 필요하게 된다.
- 타협적 결정 : 시스템 요규사항에 맞도록 가상 노드 개수를 적절히 조정
```

### 안정 해시의 이점
```
- 서버의 추가/삭제 시 재배치되는 키의 수를 최소화
- 데이터가 보다 균등하게 분포, 수평적 규모 확장성을 달성하기 쉬움
- 핫스팟 키 문제를 줄인다.(특정 샤드에 대한 지나친 접근은 서버 과부하 발생(예방 가능))
```
